\documentclass[12pt]{book}

% Packages
\usepackage[utf8]{inputenc}
\usepackage{amsmath,amssymb}
\usepackage[amsmath]{ntheorem}
\usepackage[bitstream-charter]{mathdesign}
\usepackage[dvipsnames]{xcolor}
\usepackage{listings}
\usepackage{courier}
\usepackage[hyphens]{url}
\usepackage{textcomp}
\usepackage{upquote}
\usepackage[backref=page]{hyperref}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{anyfontsize}
\usepackage{tcolorbox}
\usepackage{setspace}
\usepackage[skip=10pt plus1pt, indent=0pt]{parskip}
\usepackage{booktabs}
\usepackage{svg}
\usepackage{mathtools}
\usepackage{annotate-equations}
\usepackage{subcaption}
\usepackage[leftcaption]{sidecap}
\usepackage{soul}
\usepackage{relsize}
\usepackage{wrapfig}
\usepackage{marginnote}
\usepackage[marginparsep=0.5cm]{geometry}
\usepackage[T2A]{fontenc}      % поддержка кириллицы в выводе
\usepackage[utf8]{inputenc}    % поддержка utf8 во входных данных
\usepackage[russian]{babel}    % правила переноса и локализация для русского


% Vertical alignment for side captions
\sidecaptionvpos{figure}{c}

% Colors
\definecolor{titlecolor}{RGB}{245, 242, 238} 
\definecolor{drawgray}{HTML}{666666}
\definecolor{drawgray_l}{HTML}{F5F5F5}
\definecolor{drawblue}{HTML}{6C8EBF}
\definecolor{drawblue_l}{HTML}{DAE8FC}
\definecolor{drawgreen}{HTML}{82B366}
\definecolor{drawgreen_l}{HTML}{D5E8D4}
\definecolor{draworange}{HTML}{D79B00}
\definecolor{draworange_l}{HTML}{FFE6CC}
\definecolor{drawyellow}{HTML}{D6B656}
\definecolor{drawyellow_l}{HTML}{FFF2CC}
\definecolor{drawred}{HTML}{B85450}
\definecolor{drawred_l}{HTML}{EA6B66}
\definecolor{drawviolet}{HTML}{9673A6}
\definecolor{drawviolet_l}{HTML}{E1D5E7}

% Soul
\DeclareRobustCommand{\hlred}[1]{{\sethlcolor{drawred!30}\hl{#1}}}
\DeclareRobustCommand{\hlgreen}[1]{{\sethlcolor{drawgreen!30}\hl{#1}}}
\DeclareRobustCommand{\hlblue}[1]{{\sethlcolor{drawblue!30}\hl{#1}}}


% Tcolorbox defaults
\tcbset {
  base/.style={
    arc=0mm, 
    bottomtitle=0.5mm,
    boxrule=0mm,
    colbacktitle=drawblue_l, 
    colframe=drawblue,
    coltitle=black,
    fonttitle=\bfseries, 
    left=2.5mm,
    leftrule=1mm,
    right=3.5mm,
    title={#1},
    toptitle=0.75mm, 
  }
}

\newtcolorbox{supportbox}[1]{
  colframe=drawblue, 
  base={#1}
}

% URL size
\renewcommand*{\UrlFont}{\ttfamily\smaller\relax}

% Fancy header
\usepackage{fancyhdr}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\fancyhead{} % clear all header fields
\fancyhead[LE]{{\color{black!40}\thepage}}
\fancyhead[RE]{\bfseries\normalfont {\color{black!40}\nouppercase{\rightmark}}}
\fancyhead[LO]{\bfseries\normalfont {\color{black!40}\nouppercase{Глава \thechapter: \leftmark}}}
\fancyhead[RO]{{\color{black!40}\thepage}}

% Mathematical commands
\newcommand*{\vc}[1]{\boldsymbol{\mathbf{#1}}}
\newcommand*{\idx}[2]{{\color{gray!70}\left[\kern-\nulldelimiterspace\right.}#1{\color{gray!70}\left.\kern-\nulldelimiterspace\right]}_{\color{gray!70}#2}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

% Captions
\DeclareCaptionFormat{custom}
{%
    \textbf{#1#2}\textit{\small #3}
}
\captionsetup{format=custom}

% Theorems and definitions
% hhttps://tex.stackexchange.com/questions/26041/different-colorcoded-theorems/26049#26049
\usepackage[style=0,ntheorem]{mdframed}
\mdfsetup{%
topline=false,
rightline=false,
bottomline=false,
linewidth=3pt,
innerleftmargin=15pt,
innerrightmargin=0pt,
skipabove=\baselineskip,
skipabove=1.2\baselineskip,
}
\newmdtheoremenv[linecolor=drawred]{definition}{Определение}[chapter]

% Theorems and definitions
% hhttps://tex.stackexchange.com/questions/26041/different-colorcoded-theorems/26049#26049
\usepackage[style=0,ntheorem]{mdframed}
\mdfsetup{%
topline=false,
rightline=false,
bottomline=false,
linewidth=3pt,
innerleftmargin=15pt,
innerrightmargin=0pt,
skipabove=\baselineskip,
skipabove=1.2\baselineskip,
}
\newmdtheoremenv[linecolor=drawviolet]{theorem}{Теорема}[chapter]

% Python environment (development)
%\usepackage[newfloat=true,finalizecache,cachedir=mintedcache]{minted}
% Python environment (arXiv, remember to copy the pyg cache)
\usepackage[newfloat=true,frozencache,cachedir=mintedcache]{minted}
%\usepackage[newfloat=true]{minted}
\SetupFloatingEnvironment{listing}{name=Листинг}
\surroundwithmdframed[linecolor=drawgreen]{minted}
\newenvironment{mypy}[2]{%
\VerbatimEnvironment
\def\myenvargumentI{#1}%
\def\myenvargumentII{#2}%
\begin{listing}[t]
\footnotesize%
\begin{minted}{python}%
}{%
\end{minted}%
\caption{\myenvargumentI}
\label{\myenvargumentII}
\end{listing}
}

% Numbering
\renewcommand{\theequation}{E.\thechapter.\arabic{equation}}
\renewcommand{\thetable}{T.\thechapter.\arabic{table}}
\renewcommand{\thefigure}{F.\thechapter.\arabic{figure}}
\renewcommand{\thedefinition}{D.\thechapter.\arabic{definition}}
\renewcommand{\thelisting}{C.\thechapter.\arabic{listing}}

% tcolorbox with footnote at the end of the page
% https://tex.stackexchange.com/questions/619214/footnote-inside-and-then-outsite-tcolorbox
\usepackage{environ}% added  <<<<<<<<<<<<
\usepackage{footnote}
\NewEnviron{TCBx}{ % footnotes ouside the box
    \begin{savenotes}
        \begin{tcolorbox}
                \BODY   
        \end{tcolorbox}
    \end{savenotes}
}

% Colors of hyperref
\hypersetup{
    colorlinks=true,
    linkcolor=drawred_l,
    breaklinks=true,
    citecolor = drawred_l,
    urlcolor=drawblue,
}

% Chapter title
\usepackage{titlesec, blindtext, color}
\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}
\titleformat{\chapter}[hang]{\Huge\bfseries}{\selectfont \thechapter\hsp\textcolor{gray75}{|}\hsp}{0pt}{\Huge\bfseries}

\newcommand{\addclock}{\marginnote{\includegraphics[width=1.27cm]{images/clock.jpg}}}
\newcommand{\addteacup}{\marginnote{\includegraphics[width=1.25cm]{images/teacup.jpg}}}
\newcommand{\addbottle}{\marginnote{\includegraphics[width=1.25cm]{images/definition.png}}}
\newcommand{\addalice}{\marginnote{\includegraphics[width=2cm]{images/shutterstock_2075221579.jpg}}}

%\includeonly{4_linear_models}

\begin{document}

\begin{titlepage}
\pagecolor{titlecolor}

    \begin{flushright}
    {\Huge
    \vspace{20em}
        {\fontsize{30}{30}\selectfont Приключения Алисы в {\color{Peach}\textbf{дифференцируемой}} стране чудес}\\
        \vskip0.5cm
        {\fontsize{20}{20}\selectfont \textit{Букварь по проектированию нейронных сетей}} \\ {\fontsize{18}{18}\selectfont \textbf{Том I - Путешествие по стране}}\\
        \vskip1cm
       \large Симоне Скардапане
    }
    \end{flushright}
    \tikz[remember picture,overlay] \node[opacity=0.1,inner sep=0pt] at (4, -5){\includegraphics[width=11.5cm]{images/Alice-1.pdf}};

\end{titlepage}

\clearpage
\setstretch{1}

\vspace*{0.1\paperheight}

\begin{spacing}{1.2}
\tikz[remember picture,overlay] \node[opacity=1.0,inner sep=0pt] at (3, -7.5){\includegraphics[width=11cm]{images/Shutterstock_1977296960.png}};
\begin{quote}\begin{flushright}\large“\textit{Видите ли, в последнее время произошло столько невероятных событий, что Алиса начала думать, что на самом деле очень мало что действительно невозможно.}” \\\vspace{1em} — \textbf{Глава 1, Вниз по кроличьей норе}\end{flushright}\end{quote}
\end{spacing}
\newpage\pagecolor{white}


\frontmatter

\chapter*{Предисловие}
\markboth{}{}

%\addcontentsline{toc}{chapter}{Foreword}

Эта книга — введение в тему (глубоких) \textbf{нейронных сетей} (НС), основной технологии, лежащей в основе больших языковых моделей, генеративного искусственного интеллекта и многих других приложений. Поскольку термин \textit{нейронный} несет в себе большой исторический багаж, и поскольку НС — это просто композиции дифференцируемых примитивов, я буду называть их — по возможности — более простым термином \textbf{дифференцируемые модели}.

В 2009 году я почти случайно наткнулся на статью Йошуа Бенжио о мощи «глубоких» НС \cite{bengio2009learning}, в то же время, когда становились популярными библиотеки для автоматического дифференцирования, такие как Theano \cite{al2016theano}. Как и Алиса, я наткнулся на странное царство программирования — \textit{дифференцируемую} страну чудес, где простые вещи, такие как выбор элемента, были невероятно сложны, а другие вещи, такие как распознавание кошек, были удивительно просты.

Я потратил более десяти лет на чтение, реализацию и преподавание этих моделей. Эта книга — грубая попытка сжато изложить то, что я узнал в процессе, с акцентом на их проектирование и наиболее распространенные компоненты. Поскольку область быстро развивается, я постарался найти хороший баланс между теорией и кодом, историческими соображениями и последними тенденциями. Я предполагаю, что читатель знаком с машинным обучением и линейной алгеброй, но стараюсь при необходимости освещать предварительные сведения.

\vspace{3.5em}
\hfill%
\begin{minipage}{0.75\textwidth}\begin{flushright}\large
\textit{Собирайтесь, друзья: пришло время для любимых нами \\ {\color{drawred}{приключений Алисы в дифференцируемой стране чудес}}!}\end{flushright}
\end{minipage}
\tikz[remember picture,overlay] \node[opacity=1.0,inner sep=0pt] at (-13.5,-1.3){\includegraphics[width=6.5cm]{images/shutterstock_1675103158.jpg}};

\newpage

\pagestyle{empty}
{
\hypersetup{linkcolor=drawred}
\setcounter{tocdepth}{1}
\tableofcontents
}
\pagestyle{fancy}


\mainmatter

\include{1_introduction}

% Note to self: this is a mess
\part[Компас и игла]{
\pagecolor{titlecolor}
\label{part:compass_and_needle}
\vspace*{1em}
\begin{flushright}
\vspace{-2em}Компас и игла\end{flushright}\vspace*{2em}
\begin{spacing}{1.2}
\begin{minipage}[l]{17cm}
\begin{quote}\begin{flushright}
\normalfont\large\textit{“Скажите, пожалуйста, куда мне отсюда идти?” \\
“Это во многом зависит от того, куда ты хочешь попасть”, — сказал Кот.\\
“Мне все равно, куда”, — сказала Алиса.\\
“Тогда неважно, куда идти”, — сказал Кот.} \\\vspace{1em} — \textbf{Глава 6, Свинья и перец}
\end{flushright}\end{quote} 
\tikz[remember picture,overlay] \node[opacity=0.8,inner sep=0pt] at (3,10){\includegraphics[width=8cm]{images/Alice-3.pdf}};
\end{minipage}\end{spacing} \newpage\pagecolor{white}
}


\include{2_preliminaries}
\include{3_datasets_and_loss_functions}
\include{4_linear_models}
\include{5_fully_connected_models}
\include{6_automatic_differentiation}

\part[Странная страна]{\pagecolor{titlecolor}
\label{part:a_strange_land}
\vspace*{1em}
\vspace{-2em}\hspace{3.8em}Странная страна\vspace*{2em}
\begin{spacing}{1.2}
\begin{minipage}[l]{15cm}
\begin{quote}\begin{flushright}
\normalfont\large\textit{“Все страньше и страньше!” — воскликнула Алиса (она была так удивлена, что на мгновение совсем забыла, \\ как правильно говорить по-английски).} \\\vspace{1em} — \textbf{Глава 2, Море слез}
\end{flushright}\end{quote} 
\tikz[remember picture,overlay] \node[opacity=0.8,inner sep=0pt] at (2.5,8.5){\includegraphics[width=5cm]{images/Alice-4.pdf}};
\end{minipage}\end{spacing}
\newpage
\pagecolor{white}
}

\include{7_convolutional_layers}
\include{8_convolutions_beyond_images}
\include{9_building_deep_cnns}

\part[Вниз по кроличьей норе]{\pagecolor{titlecolor}
\label{part:down_the_rabbit_hole}
\vspace*{1em}
\vspace{-2em}\hspace{6.0em} $\,$Вниз по кроличьей норе\vspace*{2em}
\begin{spacing}{1.2}
\begin{minipage}[l]{15cm}
\begin{quote}\begin{flushright}
\normalfont\large\textit{“Было бы так хорошо, если бы хоть что-то имело смысл для разнообразия.”} \\\vspace{1em} \textbf{—Алиса в стране чудес, фильм 1951 года}
\end{flushright}\end{quote} 
\tikz[remember picture,overlay] \node[opacity=1.0,inner sep=0pt] at (3,6.5){\includegraphics[width=7.5cm]{images/Shutterstock_2274674539.png}};
\end{minipage}\end{spacing}
\newpage\pagecolor{white}
}

\include{10_transformers}
\include{11_advanced_transformers}
\include{12_graph_models}
\include{13_recurrent_models}

\pagecolor{white}
\chapter*{До свидания (пока что)}

И вот, первое путешествие Алисы в этой дифференцируемой стране чудес подошло (пока что) к концу. Мы совершили лишь очень общий обзор, сосредоточившись на множестве способов, которыми слои могут быть спроектированы и скомпонованы для создания современных дифференцируемых моделей (также известных как нейронные сети).

\begin{wrapfigure}{r}{6.5cm}
\includegraphics[width=6.5cm]{images/alice_mad_hatter.jpg}
\end{wrapfigure} 

Есть много тем, которые мы обсуждали лишь вкратце, включая то, как мы можем \textit{использовать} эти модели на практике: от дообучения до генеративного моделирования, объяснимости и многого другого. Мы также поверхностно коснулись многих инженерных аспектов: обучение и обслуживание больших моделей — это огромный инженерный подвиг, который требует, среди прочего, распределенных стратегий обучения, быстрых компиляторов и техник DevOps. А появление БЯМ открыло новые возможности для их использования, где знание их внутреннего устройства даже не является обязательным условием, от промпт-инжиниринга до цепочек моделей и агентного поведения.

У этой книги есть сопутствующий веб-сайт,\footnote{\url{https://sscardapane.it/alice-book}} где я надеюсь опубликовать дополнительные главы, затрагивающие некоторые из этих тем. Если позволит время, некоторые из них могут быть объединены в новый том.

Надеюсь, вам понравилось путешествие! За комментариями, предложениями и отзывами о книге не стесняйтесь обращаться ко мне.

\newpage
\pagecolor{white}
\pagestyle{fancy}

\appendix
\fancyhead[LO]{\bfseries\normalfont {\color{black!40}\nouppercase{Приложение \thechapter: \leftmark}}}
\include{appendix_a}
\include{appendix_b}

\bibliographystyle{alphaabbr}
\footnotesize
\bibliography{biblio}

\end{document}